"""
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å BytesIO –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ WebP.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ:
1. convert_webp_to_png –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç BytesIO –æ–±—ä–µ–∫—Ç
2. BytesIO —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–µ PNG –¥–∞–Ω–Ω—ã–µ
3. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
"""

import io
from pathlib import Path
from core.image_processor import convert_webp_to_png
from PIL import Image


def test_bytesio_conversion():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç BytesIO."""
    print("üîç –¢–µ—Å—Ç: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ —Ç–∏–ø–∞...")

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ WebP –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞
    test_dir = Path(__file__).parent / "test_data"
    test_webp = test_dir / "test_image.webp"

    if not test_webp.exists():
        print(f"‚ö†Ô∏è  –¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: {test_webp}")
        print("   –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ WebP –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
        test_dir.mkdir(exist_ok=True)

        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img = Image.new("RGB", (100, 100), color="red")
        img.save(test_webp, "WEBP")
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ: {test_webp}")

    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
    result = convert_webp_to_png(test_webp)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –≠—Ç–æ BytesIO?
    assert isinstance(result, io.BytesIO), (
        f"‚ùå –û–∂–∏–¥–∞–ª—Å—è BytesIO, –ø–æ–ª—É—á–µ–Ω {type(result)}"
    )
    print("‚úÖ –¢–∏–ø –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è: BytesIO")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ú–æ–∂–µ–º –ª–∏ –º—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å PNG –∏–∑ –±—É—Ñ–µ—Ä–∞?
    result.seek(0)  # –°–±—Ä–æ—Å –Ω–∞ –Ω–∞—á–∞–ª–æ
    test_img = Image.open(result)
    assert test_img.format == "PNG", f"‚ùå –û–∂–∏–¥–∞–ª—Å—è PNG, –ø–æ–ª—É—á–µ–Ω {test_img.format}"
    print(f"‚úÖ –§–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä–µ: {test_img.format}")
    print(f"‚úÖ –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {test_img.size}")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ë—É—Ñ–µ—Ä –Ω–µ –ø—É—Å—Ç?
    result.seek(0, 2)  # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ–Ω–µ—Ü
    buffer_size = result.tell()
    assert buffer_size > 0, "‚ùå –ë—É—Ñ–µ—Ä –ø—É—Å—Ç–æ–π!"
    print(f"‚úÖ –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞: {buffer_size} –±–∞–π—Ç")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è?
    temp_files = list(test_dir.glob("*.png"))
    if temp_files:
        print(f"‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã PNG —Ñ–∞–π–ª—ã –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: {temp_files}")
        print("   (–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ –æ—Ç —Å—Ç–∞—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤)")
    else:
        print("‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ PNG —Ñ–∞–π–ª—ã –ù–ï —Å–æ–∑–¥–∞–Ω—ã –Ω–∞ –¥–∏—Å–∫–µ")

    print("\nüéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ BytesIO.")


if __name__ == "__main__":
    test_bytesio_conversion()
