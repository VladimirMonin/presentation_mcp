"""
–û—á–∏—Å—Ç–∫–∞ Markdown —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ –¥–æ–∫–ª–∞–¥—á–∏–∫–∞.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç Markdown —Ä–∞–∑–º–µ—Ç–∫—É –≤ —á–∏—Å—Ç—ã–π —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç,
—É–¥–∞–ª—è—è –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å.
"""

import logging
import markdown
from bs4 import BeautifulSoup
from typing import Optional

logger = logging.getLogger(__name__)


def clean_markdown_for_notes(md_text: str) -> str:
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Markdown –≤ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ –¥–æ–∫–ª–∞–¥—á–∏–∫–∞.

    –ü—Ä–æ—Ü–µ—Å—Å:
    1. Markdown ‚Üí HTML (—á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É markdown)
    2. HTML ‚Üí plain text (—á–µ—Ä–µ–∑ BeautifulSoup)
    3. –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
    4. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤

    Args:
        md_text: –¢–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.

    Returns:
        –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –≥–æ—Ç–æ–≤—ã–π –¥–ª—è –∑–∞–º–µ—Ç–æ–∫.

    Note:
        - –°–ø–∏—Å–∫–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –º–∞—Ä–∫–µ—Ä–æ–≤
        - –ñ–∏—Ä–Ω—ã–π/–∫—É—Ä—Å–∏–≤ —É–¥–∞–ª—è—é—Ç—Å—è
        - –°—Å—ã–ª–∫–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç
        - –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
        - –ö–æ–¥-–±–ª–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç

    Example:
        >>> md = "# –ó–∞–≥–æ–ª–æ–≤–æ–∫\\n\\n- –ü—É–Ω–∫—Ç **–∂–∏—Ä–Ω—ã–π**\\n- –î—Ä—É–≥–æ–π"
        >>> clean = clean_markdown_for_notes(md)
        >>> print(clean)
        –ó–∞–≥–æ–ª–æ–≤–æ–∫
        –ü—É–Ω–∫—Ç –∂–∏—Ä–Ω—ã–π
        –î—Ä—É–≥–æ–π
    """
    if not md_text:
        logger.debug("üßπ –ü—É—Å—Ç–æ–π –≤—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É")
        return ""

    input_length = len(md_text)
    logger.debug(f"üßπ –û—á–∏—Å—Ç–∫–∞ Markdown, –¥–ª–∏–Ω–∞ –≤—Ö–æ–¥–∞: {input_length} —Å–∏–º–≤–æ–ª–æ–≤")

    try:
        # –®–∞–≥ 1: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Markdown –≤ HTML
        html = markdown.markdown(md_text)
        logger.debug(f"üîß Markdown ‚Üí HTML: {len(html)} —Å–∏–º–≤–æ–ª–æ–≤")

        # –®–∞–≥ 2: –ü–∞—Ä—Å–∏–º HTML —Å BeautifulSoup
        soup = BeautifulSoup(html, "html.parser")

        # –®–∞–≥ 3: –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç (BeautifulSoup –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ—Ç —Ç–µ–≥–∏)
        # separator="\n" —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∞–±–∑–∞—Ü–µ–≤
        text = soup.get_text(separator="\n").strip()

        # –®–∞–≥ 4: –û—á–∏—Å—Ç–∫–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
        lines = [line.strip() for line in text.splitlines() if line.strip()]
        clean_text = "\n".join(lines)

        output_length = len(clean_text)
        logger.debug(f"‚ú® –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –¥–ª–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞: {output_length} —Å–∏–º–≤–æ–ª–æ–≤")

        return clean_text

    except Exception as e:
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
        # (–ª—É—á—à–µ –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ-—Ç–æ, —á–µ–º –Ω–∏—á–µ–≥–æ)
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ Markdown: {e}", exc_info=True)
        return md_text


def clean_markdown_preserve_structure(md_text: str) -> str:
    """
    –û—á–∏—â–∞–µ—Ç Markdown —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∞–±–∑–∞—Ü–µ–≤ –∏ –æ—Ç—Å—Ç—É–ø–æ–≤.

    –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç clean_markdown_for_notes, —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç
    –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.

    Args:
        md_text: –¢–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.

    Returns:
        –ß–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤.

    Example:
        >>> md = "–ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ.\\n\\n–í—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ."
        >>> clean = clean_markdown_preserve_structure(md)
        >>> print(clean)
        –ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ.

        –í—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ.
    """
    if not md_text:
        logger.debug("üßπ –ü—É—Å—Ç–æ–π –≤—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç (preserve_structure)")
        return ""

    logger.debug(f"üßπ –û—á–∏—Å—Ç–∫–∞ Markdown —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –¥–ª–∏–Ω–∞: {len(md_text)} —Å–∏–º–≤–æ–ª–æ–≤")

    try:
        html = markdown.markdown(md_text)
        soup = BeautifulSoup(html, "html.parser")

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –±–ª–æ—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
        blocks = []
        for element in soup.find_all(
            ["p", "h1", "h2", "h3", "h4", "h5", "h6", "li", "blockquote"]
        ):
            text = element.get_text().strip()
            if text:
                blocks.append(text)

        # –°–æ–µ–¥–∏–Ω—è–µ–º –±–ª–æ–∫–∏ –¥–≤–æ–π–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏
        result = "\n\n".join(blocks)
        logger.debug(f"‚ú® –û—á–∏—Å—Ç–∫–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {len(result)} —Å–∏–º–≤–æ–ª–æ–≤")
        return result

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ Markdown (preserve_structure): {e}", exc_info=True)
        return md_text


def validate_markdown(md_text: str) -> Optional[str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å Markdown —Ç–µ–∫—Å—Ç–∞.

    Args:
        md_text: –¢–µ–∫—Å—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

    Returns:
        None, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –≤–∞–ª–∏–¥–µ–Ω.
        –°—Ç—Ä–æ–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞.

    Example:
        >>> error = validate_markdown("# –ó–∞–≥–æ–ª–æ–≤–æ–∫\\n\\n–¢–µ–∫—Å—Ç")
        >>> if error:
        ...     print(f"–û—à–∏–±–∫–∞: {error}")
    """
    logger.debug(f"üîç –í–∞–ª–∏–¥–∞—Ü–∏—è Markdown, –¥–ª–∏–Ω–∞: {len(md_text) if md_text else 0} —Å–∏–º–≤–æ–ª–æ–≤")
    
    if not md_text:
        logger.warning("‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç")
        return "–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç"

    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å
        html = markdown.markdown(md_text)

        # –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if not html or html.isspace():
            logger.warning("‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è: Markdown –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–ª—Å—è –≤ –ø—É—Å—Ç–æ–π HTML")
            return "Markdown –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–ª—Å—è –≤ –ø—É—Å—Ç–æ–π HTML"

        logger.debug("‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è Markdown —É—Å–ø–µ—à–Ω–∞")
        return None  # –í—Å—ë –û–ö

    except Exception as e:
        error_msg = f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {str(e)}"
        logger.error(f"‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è Markdown: {error_msg}", exc_info=True)
        return error_msg


# –¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã (–¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏)

TEST_CASES = [
    {
        "name": "–ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç",
        "input": "–ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –±–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏.",
        "expected": "–ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –±–µ–∑ —Ä–∞–∑–º–µ—Ç–∫–∏.",
    },
    {
        "name": "–ñ–∏—Ä–Ω—ã–π –∏ –∫—É—Ä—Å–∏–≤",
        "input": "–¢–µ–∫—Å—Ç —Å **–∂–∏—Ä–Ω—ã–º** –∏ *–∫—É—Ä—Å–∏–≤–æ–º*.",
        "expected": "–¢–µ–∫—Å—Ç —Å –∂–∏—Ä–Ω—ã–º –∏ –∫—É—Ä—Å–∏–≤–æ–º.",
    },
    {
        "name": "–ó–∞–≥–æ–ª–æ–≤–∫–∏",
        "input": "# –ó–∞–≥–æ–ª–æ–≤–æ–∫ 1\n## –ó–∞–≥–æ–ª–æ–≤–æ–∫ 2\n–¢–µ–∫—Å—Ç",
        "expected": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1\n–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2\n–¢–µ–∫—Å—Ç",
    },
    {
        "name": "–°–ø–∏—Å–∫–∏",
        "input": "- –ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç\n- –í—Ç–æ—Ä–æ–π –ø—É–Ω–∫—Ç\n- –¢—Ä–µ—Ç–∏–π –ø—É–Ω–∫—Ç",
        "expected": "–ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç\n–í—Ç–æ—Ä–æ–π –ø—É–Ω–∫—Ç\n–¢—Ä–µ—Ç–∏–π –ø—É–Ω–∫—Ç",
    },
    {
        "name": "–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏",
        "input": "1. –û–¥–∏–Ω\n2. –î–≤–∞\n3. –¢—Ä–∏",
        "expected": "–û–¥–∏–Ω\n–î–≤–∞\n–¢—Ä–∏",
    },
    {
        "name": "–°—Å—ã–ª–∫–∏",
        "input": "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ [—ç—Ç—É —Å—Å—ã–ª–∫—É](https://example.com).",
        "expected": "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É.",
    },
    {
        "name": "–ö–æ–¥ inline",
        "input": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `–∫–æ–¥` –≤ —Ç–µ–∫—Å—Ç–µ.",
        "expected": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–¥ –≤ —Ç–µ–∫—Å—Ç–µ.",
    },
    {
        "name": "–ë–ª–æ–∫ –∫–æ–¥–∞",
        "input": "```python\nprint('hello')\n```",
        "expected": "print('hello')",
    },
    {"name": "–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç", "input": "", "expected": ""},
    {
        "name": "–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏",
        "input": "–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞\n\n\n\n–í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞",
        "expected": "–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞\n–í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞",
    },
]


def run_tests() -> bool:
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏.

    Returns:
        True, –µ—Å–ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ, –∏–Ω–∞—á–µ False.
    """
    print("=" * 60)
    print("–¢–ï–°–¢–´: –û—á–∏—Å—Ç–∫–∞ Markdown")
    print("=" * 60)

    passed = 0
    failed = 0

    for test in TEST_CASES:
        result = clean_markdown_for_notes(test["input"])

        if result == test["expected"]:
            passed += 1
            print(f"‚úì {test['name']}")
        else:
            failed += 1
            print(f"‚úó {test['name']}")
            print(f"  –û–∂–∏–¥–∞–ª–æ—Å—å: {repr(test['expected'])}")
            print(f"  –ü–æ–ª—É—á–µ–Ω–æ:  {repr(result)}")

    print()
    print(f"–ü—Ä–æ–π–¥–µ–Ω–æ: {passed}/{len(TEST_CASES)}")
    print(f"–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {failed}/{len(TEST_CASES)}")
    print("=" * 60)

    return failed == 0


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤—ã–∑–æ–≤–µ –º–æ–¥—É–ª—è
    success = run_tests()
    exit(0 if success else 1)
